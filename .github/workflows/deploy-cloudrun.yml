name: Deploy to Google Cloud Run (from GHCR image)

on:
  workflow_dispatch: {}   # manual trigger via GitHub Actions tab

env:
  GCP_PROJECT_ID: clear-rock-477020-a0
  GCP_REGION: europe-west6
  GAR_REPOSITORY: app
  SERVICE_NAME: spring-react-crud
  IMAGE_NAME: spring-react-crud
  SPRING_PROFILES_ACTIVE: demo

jobs:
  deploy:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
   # .github/workflows/deploy-cloudrun.yml (deploy job)
    steps:
      - uses: actions/checkout@v4

      # Auth to GCP with your JSON key secret
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: clear-rock-477020-a0
          service_account_key: ${{ secrets.GCP_CREDENTIALS }}
          export_default_credentials: true

      # Configure Docker credential helper for Artifact Registry
      - name: Enable AR docker helper
        run: gcloud auth configure-docker europe-west6-docker.pkg.dev --quiet

      # ðŸ”’ Explicit docker login with access token (belt + suspenders)
      - name: Docker login to AR
        run: |
          TOKEN="$(gcloud auth print-access-token)"
          echo "$TOKEN" | docker login -u oauth2accesstoken --password-stdin https://europe-west6-docker.pkg.dev

      # Pull from GHCR, retag to AR, and push
      - name: Copy image GHCR â†’ AR
        run: |
          SRC=ghcr.io/chhex/spring-boot-react-crud-revisited2:latest
          DST=europe-west6-docker.pkg.dev/clear-rock-477020-a0/app/spring-react-crud:latest
          docker pull "$SRC"
          docker tag  "$SRC" "$DST"
          docker push "$DST"

      # Deploy to Cloud Run
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: spring-react-crud
          region:  europe-west6
          image:   europe-west6-docker.pkg.dev/clear-rock-477020-a0/app/spring-react-crud:latest
          flags: |
            --port=8080
            --allow-unauthenticated
            --memory=512Mi
            --max-instances=1
            --set-env-vars=SPRING_PROFILES_ACTIVE=demo