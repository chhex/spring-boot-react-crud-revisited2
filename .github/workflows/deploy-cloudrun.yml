name: Deploy to Google Cloud Run (from GHCR image)

on:
  workflow_dispatch: {}

env:
  GCP_PROJECT_ID: clear-rock-477020-a0
  GCP_REGION: europe-west6
  GAR_REPOSITORY: app
  SERVICE_NAME: spring-react-crud
  IMAGE_NAME: spring-react-crud
  SPRING_PROFILES_ACTIVE: demo

jobs:
  deploy:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Auth to GCP with SA JSON in secret
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_CREDENTIALS }}
          export_default_credentials: true

      # Configure Docker cred helper for Artifact Registry
      - name: Enable Artifact Registry docker auth
        run: gcloud auth configure-docker $GCP_REGION-docker.pkg.dev --quiet

      # (Belt & suspenders) Explicit docker login to AR with OAuth token
      - name: Docker login to Artifact Registry
        run: |
          gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin https://$GCP_REGION-docker.pkg.dev

      # Copy ONLY the amd64 variant from GHCR -> Artifact Registry
      - name: Setup crane
        uses: imjasonh/setup-crane@v0.4

      - name: Copy GHCR → AR (amd64)
        run: |
          SRC=ghcr.io/chhex/spring-boot-react-crud-revisited2:latest
          DST=$GCP_REGION-docker.pkg.dev/$GCP_PROJECT_ID/$GAR_REPOSITORY/$IMAGE_NAME:latest
          crane cp --platform=linux/amd64 "$SRC" "$DST"

      # Deploy to Cloud Run
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region:  ${{ env.GCP_REGION }}
          image:   ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
          flags: |
            --port=8080
            --allow-unauthenticated
            --memory=512Mi
            --max-instances=1
            --set-env-vars=SPRING_PROFILES_ACTIVE=${{ env.SPRING_PROFILES_ACTIVE }}

      - name: Display Cloud Run URL
        run: |
          URL=$(gcloud run services describe $SERVICE_NAME --region $GCP_REGION --format='value(status.url)')
          echo "✅ Deployed successfully: $URL"